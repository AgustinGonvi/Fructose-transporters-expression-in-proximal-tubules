---
title: "04 Renal Segment Preprocessing: Mean and Median per Segment"
author: "Ronghao Zhang"
date: "`r Sys.Date()`"
output:
    rmdformats::readthedown:
      code_folding: show
      highlight: kate
      number_sections: TRUE
      thumbnails: FALSE
      fig_width: 8
---

# Preliminaries
```{r setup, echo=FALSE, cache=FALSE, warning=FALSE}
# Packages for Preliminaries 
library(knitr)
library(rmdformats)

# Global options
options(max.print="75")
opts_chunk$set(comment=NA)
opts_knit$set(width=75)
```

## R Packages
This code chunk load up the necessary R packages.
```{r load_packages, message=FALSE, warning=FALSE}
library(tidyverse)
```

## Themes
This code chunk set the theme of plots. 
```{r plot_theme, message=FALSE}
theme_set(theme_bw())
plot_theme <- theme(text=element_text(size=12, family="serif")) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank())
```

# Import and Tidy the Data

## Import the Data
Import the count and mata data matrix. The `raw_count` variable is generated using `rSubread`, while the `mata_data` variable stores the index of each files, this is downloaded directly from ENA website (Project Nnumber: PRJNA244440).
```{r import_csv}
# load raw count matrix generated by rSubRead
raw_count <- read.table("./../00_Inputs/count_matrix.csv", 
                       header = TRUE, sep = ",")

# load the metadata
meta_data <- read.table("./../00_Inputs/PRJNA244440_metadata.txt", 
                       header = TRUE, sep = "\t")
```

## Pre-Processing 
```{r pre-processing}
# order the metadata
meta_data <- dplyr::arrange(meta_data,run_accession) %>% 
  select(-sample_accession)

# update the rownames of the metadata matrix
#row.names(meta_data) <- meta_data$run_accession
#meta_data <- meta_data %>% select(-run_accession)

# update the rownames of the count matrix
row.names(raw_count) <- raw_count$X
raw_count <- raw_count %>% select(-X)

# log2 transform the data
log_count <- log2(raw_count+1)

# check whether the run accession number match the metadata number
# if FALSE: there is no error, good to proceed
# if TRUE: there is (are) errors, please check
FALSE %in% (check1 <- colnames(raw_count) %in% meta_data$run_accession)
```

# Process the Data

This section generates 2 separate tables: [1] mean by segment [2] median by segment.
```{r mean_and_median_by_segment}
# transpose the log count matrix
log_count_t <- t(log_count)

# calculate the mean by segment
mean_by_segment <- aggregate(log_count_t[,], 
                             list(meta_data$sample_title), mean) %>% 
  t() %>% as.data.frame()

# calculate the median by segment
median_by_segment <- aggregate(log_count_t[,], 
                               list(meta_data$sample_title), median) %>%
  t() %>% as.data.frame()
```

# Export CSV Files
```{r export_csv_files}
# assign the column names 
colnames(mean_by_segment) <- mean_by_segment[1,]
colnames(median_by_segment) <- median_by_segment[1,]

# delete the first row (duplicated column name)
write.csv(median_by_segment[2:dim(median_by_segment)[1],],
          "./../02_Results/median_by_segment.csv",row.names = TRUE)

write.csv(mean_by_segment[2:dim(mean_by_segment)[1],],
          "./../02_Results/mean_by_segment.csv",row.names = TRUE)
```

# Session Info
```{r}
sessionInfo()
```

